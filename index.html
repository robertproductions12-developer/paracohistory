<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StoryCanvas Live Pro</title>
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --card-dark: #1e293b;
            --accent: #8b5cf6;
            --accent-hover: #7c3aed;
            --text: #f8fafc;
        }

        /* FONDO ANIMADO DEGRADADO */
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        * { box-sizing: border-box; touch-action: manipulation; }

        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: 'Segoe UI', system-ui, sans-serif;
            color: var(--text);
            overflow: hidden;
            background: linear-gradient(-45deg, #0f172a, #1e293b, #312e81, #1e1b4b);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        /* LOGIN */
        #login-screen {
            position: fixed; inset: 0; 
            display: flex; align-items: center; justify-content: center; z-index: 1000;
            background: inherit;
        }
        .login-box {
            background: rgba(30, 41, 59, 0.8); padding: 2.5rem; border-radius: 2rem;
            text-align: center; width: 90%; max-width: 400px;
            backdrop-filter: blur(10px);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* APP LAYOUT */
        .app-container { display: flex; flex-direction: column; height: 100vh; }

        header {
            padding: 0.8rem 1rem; background: rgba(30, 41, 59, 0.9);
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
        }

        /* ZONA DE DIBUJO */
        #canvas-section {
            padding: 10px; display: flex; flex-direction: column; align-items: center;
        }

        .canvas-wrapper {
            position: relative; width: 100%; max-width: 420px; aspect-ratio: 1/1;
            background: white; border-radius: 1.2rem; overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.4);
        }

        canvas { width: 100%; height: 100%; cursor: crosshair; touch-action: none; }

        /* CONTROLES MEJORADOS */
        .toolbar {
            display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; 
            width: 100%; max-width: 420px; justify-content: center;
            background: rgba(30, 41, 59, 0.5); padding: 10px; border-radius: 1rem;
        }

        .tool-group { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.05); padding: 5px 10px; border-radius: 0.5rem; }

        input[type="color"] {
            border: none; width: 35px; height: 35px; background: none; cursor: pointer;
        }

        input[type="range"] { width: 80px; accent-color: var(--accent); }

        .emoji-btn { font-size: 1.2rem; background: none; border: 1px solid #444; padding: 5px; border-radius: 5px; cursor: pointer; transition: 0.2s; }
        .emoji-btn:hover { background: rgba(255,255,255,0.1); transform: scale(1.1); }

        /* HISTORIA */
        #history-section {
            flex: 1; overflow-y: auto; padding: 1rem;
            background: rgba(15, 23, 42, 0.3);
        }

        .chat-bubble {
            background: var(--card-dark); padding: 12px; border-radius: 1.2rem;
            margin-bottom: 1rem; border-left: 5px solid var(--accent);
            animation: slideIn 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        .chat-bubble b { color: var(--accent); font-size: 0.85rem; display: block; margin-bottom: 5px; }
        .chat-bubble img { width: 100%; border-radius: 0.8rem; background: white; display: block; }

        /* BOTONES */
        button {
            padding: 8px 15px; border-radius: 0.8rem; border: none;
            font-weight: bold; cursor: pointer; transition: 0.3s;
            color: white;
        }
        .btn-main { background: var(--accent); flex: 1; }
        .btn-main:hover { background: var(--accent-hover); }
        .btn-secondary { background: #475569; font-size: 0.8rem; }
        .btn-danger { background: #ef4444; font-size: 0.75rem; }

        .hidden { display: none !important; }
        @keyframes slideIn { from { opacity: 0; transform: scale(0.9) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    </style>
</head>
<body>

    <!-- Pantalla de Login -->
    <div id="login-screen">
        <div class="login-box">
            <h1 style="margin:0 0 0.5rem 0; font-size: 2rem; background: linear-gradient(to right, #a78bfa, #f472b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">StoryCanvas</h1>
            <p style="color: #94a3b8; margin-bottom: 1.5rem">Dibuja la historia con otros</p>
            <input type="text" id="username" placeholder="Tu nombre art√≠stico..." 
                   style="width:100%; padding:14px; border-radius:12px; border:1px solid #334155; background:#0f172a; color:white; margin-bottom:1.5rem; outline:none">
            <button class="btn-main" style="width:100%; padding:14px" onclick="join()">Entrar al Lienzo</button>
        </div>
    </div>

    <!-- Interfaz de Juego -->
    <div id="app" class="app-container hidden">
        <header>
            <button class="btn-secondary" onclick="goBack()">‚Üê Salir</button>
            <div id="status" style="font-size: 0.9rem">üé® <span id="user-tag" style="color:var(--accent); font-weight:bold"></span></div>
            <button class="btn-danger" onclick="clearAll()">Reiniciar</button>
        </header>

        <section id="canvas-section">
            <div class="canvas-wrapper">
                <canvas id="mainCanvas"></canvas>
            </div>
            
            <div class="toolbar">
                <div class="tool-group">
                    <input type="color" id="colorPicker" value="#8b5cf6">
                    <input type="range" id="sizePicker" min="2" max="50" value="5">
                </div>
                <div class="tool-group">
                    <button class="emoji-btn" onclick="setTool('pen')">üñåÔ∏è</button>
                    <button class="emoji-btn" onclick="setTool('emoji', 'üî•')">üî•</button>
                    <button class="emoji-btn" onclick="setTool('emoji', '‚≠ê')">‚≠ê</button>
                    <button class="emoji-btn" onclick="setTool('emoji', '‚ù§Ô∏è')">‚ù§Ô∏è</button>
                    <button class="emoji-btn" onclick="setTool('emoji', 'üòÇ')">üòÇ</button>
                </div>
                <button class="btn-main" onclick="publishDrawing()">PUBLICAR MI PARTE</button>
            </div>
        </section>

        <section id="history-section">
            <div id="chat-flow"></div>
        </section>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        // CONFIGURACI√ìN FIREBASE (Misma base de datos)
        const firebaseConfig = {
           apiKey: "AIzaSyBMoyUF0bxIQtjZeZwK7nUal2gDUHWp_mc",
           authDomain: "history-4d35c.firebaseapp.com",
           projectId: "history-4d35c",
           databaseURL: "https://history-4d35c-default-rtdb.firebaseio.com",
           storageBucket: "history-4d35c.firebasestorage.app",
           messagingSenderId: "609419245306",
           appId: "1:609419245306:web:db65199fb17148dbb8bb43"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const drawingRef = db.ref('canvas_state');
        const historyRef = db.ref('story_history');

        let user = "";
        let currentTool = 'pen';
        let currentEmoji = '';
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const chatFlow = document.getElementById('chat-flow');
        const historySection = document.getElementById('history-section');
        let isDrawing = false;
        let lastPos = null;

        function initCanvas() {
            const size = canvas.parentElement.offsetWidth;
            canvas.width = size;
            canvas.height = size;
            resetCanvasStyle();
        }

        function resetCanvasStyle() {
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        function join() {
            user = document.getElementById('username').value.trim();
            if(!user) return alert("Escribe tu nombre");
            document.getElementById('user-tag').innerText = user;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            initCanvas();
            startListeners();
        }

        function goBack() {
            if(confirm("¬øQuieres volver a la pantalla principal? Tu progreso en el lienzo actual se mantendr√° en la red.")) {
                document.getElementById('app').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
                drawingRef.off();
                historyRef.off();
            }
        }

        function setTool(tool, emoji = '') {
            currentTool = tool;
            currentEmoji = emoji;
            if(tool === 'emoji') {
                canvas.style.cursor = 'crosshair';
            }
        }

        // --- L√ìGICA DE DIBUJO ---
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: (clientX - rect.left) / canvas.width,
                y: (clientY - rect.top) / canvas.height
            };
        }

        function handleStart(e) {
            isDrawing = true;
            const pos = getPos(e);
            if(currentTool === 'emoji') {
                placeEmoji(pos);
            } else {
                lastPos = pos;
            }
        }

        function handleMove(e) {
            if(!isDrawing || currentTool !== 'pen') return;
            const pos = getPos(e);
            const color = document.getElementById('colorPicker').value;
            const size = document.getElementById('sizePicker').value;

            // Enviamos trazo completo para suavidad
            drawingRef.push({
                type: 'line',
                x1: lastPos.x, y1: lastPos.y,
                x2: pos.x, y2: pos.y,
                color: color,
                size: size
            });
            lastPos = pos;
        }

        function placeEmoji(pos) {
            const size = document.getElementById('sizePicker').value;
            drawingRef.push({
                type: 'emoji',
                x: pos.x, y: pos.y,
                content: currentEmoji,
                size: size
            });
        }

        canvas.addEventListener('mousedown', handleStart);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); handleStart(e); });
        window.addEventListener('mouseup', () => isDrawing = false);
        window.addEventListener('touchend', () => isDrawing = false);
        canvas.addEventListener('mousemove', handleMove);
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); handleMove(e); });

        function drawRemoteLine(data) {
            ctx.beginPath();
            ctx.strokeStyle = data.color;
            ctx.lineWidth = data.size;
            ctx.moveTo(data.x1 * canvas.width, data.y1 * canvas.height);
            ctx.lineTo(data.x2 * canvas.width, data.y2 * canvas.height);
            ctx.stroke();
            ctx.closePath();
        }

        function drawRemoteEmoji(data) {
            ctx.font = `${data.size * 2}px serif`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(data.content, data.x * canvas.width, data.y * canvas.height);
        }

        // --- SINCRONIZACI√ìN ---
        function startListeners() {
            drawingRef.on('child_added', (snap) => {
                const data = snap.val();
                if(data.type === 'line') drawRemoteLine(data);
                if(data.type === 'emoji') drawRemoteEmoji(data);
            });

            historyRef.on('child_added', (snap) => {
                const data = snap.val();
                addToHistory(data.user, data.img);
            });

            drawingRef.on('value', snap => {
                if(!snap.exists()) resetCanvasStyle();
            });
        }

        function publishDrawing() {
            const dataUrl = canvas.toDataURL('image/webp', 0.5);
            historyRef.push({
                user: user,
                img: dataUrl,
                timestamp: Date.now()
            });
        }

        function addToHistory(author, imgData) {
            const div = document.createElement('div');
            div.className = 'chat-bubble';
            div.innerHTML = `<b>‚ú® ${author} a√±adi√≥ un cap√≠tulo:</b><img src="${imgData}">`;
            chatFlow.appendChild(div);
            
            setTimeout(() => {
                historySection.scrollTo({ top: historySection.scrollHeight, behavior: 'smooth' });
            }, 100);
        }

        function clearAll() {
            if(confirm("¬øEliminar la historia y el lienzo para todos?")) {
                drawingRef.remove();
                historyRef.remove();
                chatFlow.innerHTML = "";
            }
        }

        window.addEventListener('resize', initCanvas);
    </script>
</body>
</html>
