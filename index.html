<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StoryCanvas Live</title>
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --card-dark: #1e293b;
            --accent: #8b5cf6;
            --text: #f8fafc;
        }

        * { box-sizing: border-box; touch-action: manipulation; }

        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-dark); color: var(--text);
            overflow: hidden;
        }

        /* LOGIN */
        #login-screen {
            position: fixed; inset: 0; background: var(--bg-dark);
            display: flex; align-items: center; justify-content: center; z-index: 1000;
        }
        .login-box {
            background: var(--card-dark); padding: 2rem; border-radius: 1.5rem;
            text-align: center; width: 90%; max-width: 400px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3);
        }

        /* APP LAYOUT */
        .app-container {
            display: flex; flex-direction: column; height: 100vh;
        }

        header {
            padding: 1rem; background: var(--card-dark);
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #334155;
        }

        /* ZONA DE DIBUJO (FIJA ARRIBA) */
        #canvas-section {
            background: var(--bg-dark); padding: 10px;
            display: flex; flex-direction: column; align-items: center;
        }

        .canvas-wrapper {
            position: relative; width: 100%; max-width: 450px; aspect-ratio: 1/1;
            background: white; border-radius: 1rem; overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5);
        }

        canvas {
            width: 100%; height: 100%; cursor: crosshair;
            touch-action: none; /* Vital para móviles */
        }

        /* CONTROLES */
        .toolbar {
            display: flex; gap: 10px; margin-top: 10px; width: 100%; max-width: 450px;
        }
        input[type="color"] {
            border: none; width: 45px; height: 45px; background: none; cursor: pointer;
        }

        /* HISTORIA TIPO CHAT (SCROLL ABAJO) */
        #history-section {
            flex: 1; overflow-y: auto; padding: 1rem;
            background: var(--bg-dark); border-top: 1px solid #334155;
        }

        .chat-bubble {
            background: var(--card-dark); padding: 10px; border-radius: 1rem;
            margin-bottom: 1rem; border-left: 4px solid var(--accent);
            animation: slideIn 0.3s ease-out;
        }
        .chat-bubble b { color: var(--accent); font-size: 0.8rem; display: block; }
        .chat-bubble img { width: 100%; margin-top: 5px; border-radius: 0.5rem; background: white; }

        /* BOTONES */
        button {
            padding: 10px 20px; border-radius: 0.75rem; border: none;
            font-weight: bold; cursor: pointer; transition: 0.2s;
        }
        .btn-main { background: var(--accent); color: white; flex: 1; }
        .btn-danger { background: #ef4444; color: white; padding: 5px 10px; font-size: 0.7rem; }

        .hidden { display: none !important; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- Pantalla de Login -->
    <div id="login-screen">
        <div class="login-box">
            <h1 style="margin-top:0">ParacoHistory</h1>
            <p style="color: #94a3b8">SIGUE LA HISTORIA.</p>
            <input type="text" id="username" placeholder="Tu nombre..." 
                   style="width:100%; padding:12px; border-radius:8px; border:none; margin-bottom:1rem">
            <button class="btn-main" onclick="join()">Empezar Historia</button>
        </div>
    </div>

    <!-- Interfaz de Juego -->
    <div id="app" class="app-container hidden">
        <header>
            <div id="status">● Conectado como <span id="user-tag" style="color:var(--accent)"></span></div>
            <button class="btn-danger" onclick="clearAll()">Reiniciar Todo</button>
        </header>

        <section id="canvas-section">
            <div class="canvas-wrapper">
                <canvas id="mainCanvas"></canvas>
            </div>
            <div class="toolbar">
                <input type="color" id="colorPicker" value="#8b5cf6">
                <button class="btn-main" onclick="finishStroke()">SUBIR MI PARTE</button>
            </div>
        </section>

        <section id="history-section">
            <div id="chat-flow">
                <!-- Aquí aparecerán los dibujos guardados -->
            </div>
        </section>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        // --- CONFIGURACIÓN FIREBASE ---
        const firebaseConfig = {
           apiKey: "AIzaSyBMoyUF0bxIQtjZeZwK7nUal2gDUHWp_mc",
           authDomain: "history-4d35c.firebaseapp.com",
           projectId: "history-4d35c",
           storageBucket: "history-4d35c.firebasestorage.app",
           messagingSenderId: "609419245306",
           appId: "1:609419245306:web:db65199fb17148dbb8bb43"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const drawingRef = db.ref('canvas_state'); // Para el dibujo en tiempo real
        const historyRef = db.ref('story_history'); // Para el feed tipo chat

        let user = "";
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const chatFlow = document.getElementById('chat-flow');
        const historySection = document.getElementById('history-section');
        let isDrawing = false;

        // Inicializar Canvas
        function initCanvas() {
            const size = canvas.parentElement.offsetWidth;
            canvas.width = size;
            canvas.height = size;
            ctx.lineCap = 'round';
            ctx.lineWidth = 3;
            // Dibujar fondo blanco inicial
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        function join() {
            user = document.getElementById('username').value.trim();
            if(!user) return alert("Escribe tu nombre");
            document.getElementById('user-tag').innerText = user;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            initCanvas();
            startListeners();
        }

        // --- LÓGICA DE DIBUJO EN TIEMPO REAL ---
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: (clientX - rect.left) / canvas.width,
                y: (clientY - rect.top) / canvas.height
            };
        }

        canvas.addEventListener('mousedown', (e) => { isDrawing = true; draw(e); });
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); isDrawing = true; draw(e); });
        window.addEventListener('mouseup', () => { isDrawing = false; ctx.beginPath(); });
        window.addEventListener('touchend', () => { isDrawing = false; ctx.beginPath(); });
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); });

        function draw(e) {
            if(!isDrawing) return;
            const pos = getPos(e);
            const color = document.getElementById('colorPicker').value;

            // Enviamos el punto a Firebase para que otros lo vean en su canvas EN TIEMPO REAL
            drawingRef.push({ x: pos.x, y: pos.y, color: color });
        }

        function paintPoint(x, y, color) {
            ctx.strokeStyle = color;
            ctx.lineTo(x * canvas.width, y * canvas.height);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x * canvas.width, y * canvas.height);
        }

        // --- SINCRONIZACIÓN ---
        function startListeners() {
            // 1. Escuchar trazos en tiempo real (todos dibujan en el mismo lienzo)
            drawingRef.on('child_added', (snap) => {
                const p = snap.val();
                paintPoint(p.x, p.y, p.color);
            });

            // 2. Escuchar cuando alguien "sube" su versión de la historia al chat
            historyRef.on('child_added', (snap) => {
                const data = snap.val();
                addToHistory(data.user, data.img);
            });

            // 3. Reinicio total
            drawingRef.on('value', snap => {
                if(!snap.exists()) {
                    ctx.fillStyle = "white";
                    ctx.fillRect(0,0,canvas.width,canvas.height);
                    chatFlow.innerHTML = "";
                }
            });
        }

        // Guardar captura en el chat
        function finishStroke() {
            const dataUrl = canvas.toDataURL('image/webp', 0.5);
            historyRef.push({
                user: user,
                img: dataUrl
            });
        }

        function addToHistory(author, imgData) {
            const div = document.createElement('div');
            div.className = 'chat-bubble';
            div.innerHTML = `<b>${author} añadió a la historia:</b><img src="${imgData}">`;
            chatFlow.appendChild(div);
            
            // Auto-scroll al último dibujo (Chat Style)
            setTimeout(() => {
                historySection.scrollTo({ top: historySection.scrollHeight, behavior: 'smooth' });
            }, 100);
        }

        function clearAll() {
            if(confirm("¿Reiniciar la historia para todos los jugadores?")) {
                drawingRef.remove();
                historyRef.remove();
            }
        }

        window.addEventListener('resize', initCanvas);
    </script>
</body>
</html>
