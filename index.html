<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>StoryCanvas - Dibujo Colaborativo</title>
    
    <!-- Estilos CSS -->
    <style>
        :root {
            --primary: #6366f1;
            --danger: #ef4444;
            --bg: #f8fafc;
            --dark: #1e293b;
        }

        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg); overflow: hidden;
        }

        /* Pantalla de Login */
        #login-screen {
            position: fixed; inset: 0; background: var(--dark);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; color: white;
        }
        .login-card {
            background: white; padding: 2rem; border-radius: 1rem;
            color: var(--dark); width: 80%; max-width: 400px; text-align: center;
        }
        input[type="text"] {
            width: 100%; padding: 12px; margin: 15px 0;
            border: 2px solid #e2e8f0; border-radius: 8px; box-sizing: border-box;
        }

        /* Interfaz Principal */
        .app-container {
            display: flex; flex-direction: column; height: 100vh;
        }

        header {
            background: white; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        #game-area {
            flex: 1; display: flex; flex-direction: column; overflow: hidden;
        }

        /* Area de Dibujo */
        #canvas-wrapper {
            flex: 2; background: white; position: relative;
            touch-action: none; border-bottom: 2px solid #e2e8f0;
        }
        canvas { width: 100%; height: 100%; cursor: crosshair; }

        .toolbar {
            position: absolute; top: 10px; left: 10px;
            display: flex; gap: 8px; background: rgba(255,255,255,0.9);
            padding: 8px; border-radius: 50px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        /* Area de Chat */
        #chat-section {
            flex: 1; display: flex; flex-direction: column; background: white;
        }
        #messages {
            flex: 1; overflow-y: auto; padding: 15px;
            display: flex; flex-direction: column; gap: 8px;
        }
        .msg { padding: 6px 12px; border-radius: 12px; max-width: 85%; font-size: 0.9rem; }
        .msg.other { background: #f1f5f9; align-self: flex-start; }
        .msg.me { background: var(--primary); color: white; align-self: flex-end; }
        .msg b { display: block; font-size: 0.7rem; opacity: 0.8; }

        .chat-input {
            padding: 10px; display: flex; gap: 8px; border-top: 1px solid #eee;
        }

        button {
            padding: 10px 20px; border: none; border-radius: 8px;
            cursor: pointer; font-weight: bold; transition: 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; font-size: 0.8rem; }
        
        .hidden { display: none !important; }

        @media (min-width: 768px) {
            .app-container { flex-direction: row; }
            #chat-section { width: 350px; flex: none; border-left: 2px solid #e2e8f0; }
        }
    </style>
</head>
<body>

    <!-- Pantalla de Inicio -->
    <div id="login-screen">
        <div class="login-card">
            <h2>StoryCanvas</h2>
            <p>Creen una historia juntos a travÃ©s de dibujos</p>
            <input type="text" id="username" placeholder="Tu nombre de usuario..." maxlength="15">
            <button class="btn-primary" onclick="joinGame()">Empezar Juego</button>
        </div>
    </div>

    <!-- Juego -->
    <div class="app-container hidden" id="main-ui">
        <div id="game-area">
            <header>
                <div><b>Historia en vivo:</b> <span id="player-name"></span></div>
                <button class="btn-danger" onclick="resetStory()">Reiniciar Todo</button>
            </header>

            <div id="canvas-wrapper">
                <div class="toolbar">
                    <input type="color" id="colorPicker" value="#6366f1">
                    <button onclick="clearLocalCanvas()" style="padding:5px">ðŸ§¹</button>
                </div>
                <canvas id="canvas"></canvas>
            </div>

            <div id="chat-section">
                <div id="messages"></div>
                <div class="chat-input">
                    <input type="text" id="chatMsg" placeholder="Escribe parte de la historia...">
                    <button class="btn-primary" onclick="sendChat()">Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        // --- CONFIGURACIÃ“N DE FIREBASE (Sustituir con tus datos) ---
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_PROYECTO.firebaseapp.com",
            databaseURL: "https://TU_PROYECTO-default-rtdb.firebaseio.com",
            projectId: "TU_PROYECTO",
            storageBucket: "TU_PROYECTO.appspot.com",
            messagingSenderId: "ID_SENDER",
            appId: "TU_APP_ID"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const drawRef = db.ref('story/drawing');
        const chatRef = db.ref('story/chat');

        // Variables de estado
        let currentUser = "";
        let isDrawing = false;
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const colorPicker = document.getElementById('colorPicker');

        // Ajustar tamaÃ±o del canvas
        function resize() {
            canvas.width = canvas.parentElement.clientWidth;
            canvas.height = canvas.parentElement.clientHeight;
            reloadDrawing();
        }
        window.addEventListener('resize', resize);

        // --- LÃ“GICA DE LOGIN ---
        function joinGame() {
            const nameInput = document.getElementById('username').value.trim();
            if(!nameInput) return alert("Escribe un nombre");
            
            currentUser = nameInput;
            document.getElementById('player-name').innerText = currentUser;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-ui').classList.remove('hidden');
            
            resize();
            initListeners();
        }

        // --- LÃ“GICA DE DIBUJO ---
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: (clientX - rect.left) / canvas.width, // Normalizado 0 a 1
                y: (clientY - rect.top) / canvas.height
            };
        }

        canvas.addEventListener('mousedown', () => isDrawing = true);
        canvas.addEventListener('touchstart', () => isDrawing = true);
        window.addEventListener('mouseup', () => { isDrawing = false; ctx.beginPath(); });
        window.addEventListener('touchend', () => { isDrawing = false; ctx.beginPath(); });

        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); }, {passive: false});

        function draw(e) {
            if(!isDrawing) return;
            const pos = getPos(e);

            // Guardar en Firebase (solo enviamos puntos para sincronizar)
            drawRef.push({
                x: pos.x,
                y: pos.y,
                color: colorPicker.value,
                user: currentUser
            });
        }

        function drawPoint(x, y, color) {
            ctx.lineWidth = 3;
            ctx.lineCap = "round";
            ctx.strokeStyle = color;

            ctx.lineTo(x * canvas.width, y * canvas.height);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x * canvas.width, y * canvas.height);
        }

        // --- SINCRONIZACIÃ“N EN TIEMPO REAL ---
        function initListeners() {
            // Escuchar dibujos
            drawRef.on('child_added', (snapshot) => {
                const data = snapshot.val();
                drawPoint(data.x, data.y, data.color);
            });

            // Escuchar borrado (Reinicio)
            drawRef.on('value', (snapshot) => {
                if(!snapshot.exists()) {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
            });

            // Escuchar Chat
            chatRef.on('child_added', (snapshot) => {
                const data = snapshot.val();
                const msgBox = document.getElementById('messages');
                const div = document.createElement('div');
                div.className = `msg ${data.user === currentUser ? 'me' : 'other'}`;
                div.innerHTML = `<b>${data.user}</b>${data.text}`;
                msgBox.appendChild(div);
                msgBox.scrollTop = msgBox.scrollHeight;
            });

            // Escuchar reinicio de chat
            chatRef.on('value', (snapshot) => {
                if(!snapshot.exists()) document.getElementById('messages').innerHTML = "";
            });
        }

        function reloadDrawing() {
            drawRef.once('value', (snapshot) => {
                snapshot.forEach((child) => {
                    const data = child.val();
                    drawPoint(data.x, data.y, data.color);
                });
            });
        }

        // --- CHAT ---
        function sendChat() {
            const input = document.getElementById('chatMsg');
            if(!input.value.trim()) return;

            chatRef.push({
                user: currentUser,
                text: input.value
            });
            input.value = "";
        }

        // --- REINICIAR ---
        function resetStory() {
            if(confirm("Â¿Seguro que quieres borrar toda la historia y el dibujo?")) {
                drawRef.remove();
                chatRef.remove();
            }
        }

        function clearLocalCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            // Esto solo limpia tu vista local, para forzar redibujado de la historia:
            reloadDrawing();
        }

        // Soporte para Enter en Chat
        document.getElementById('chatMsg').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') sendChat();
        });
    </script>
</body>
</html>