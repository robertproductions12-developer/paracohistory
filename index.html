<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StoryCanvas Live Pro</title>
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --card-dark: #1e293b;
            --accent: #8b5cf6;
            --accent-hover: #7c3aed;
            --text: #f8fafc;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        * { box-sizing: border-box; touch-action: manipulation; }

        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: 'Segoe UI', system-ui, sans-serif;
            color: var(--text);
            overflow: hidden;
            background: linear-gradient(-45deg, #0f172a, #1e293b, #312e81, #1e1b4b);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        /* LOGIN */
        #login-screen {
            position: fixed; inset: 0; 
            display: flex; align-items: center; justify-content: center; z-index: 1000;
            background: inherit;
        }
        .login-box {
            background: rgba(30, 41, 59, 0.8); padding: 2.5rem; border-radius: 2rem;
            text-align: center; width: 90%; max-width: 400px;
            backdrop-filter: blur(10px);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .avatar-upload {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        #preview-avatar {
            width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
            border: 2px solid var(--accent); background: #0f172a;
        }

        /* APP LAYOUT */
        .app-container { display: flex; flex-direction: column; height: 100vh; }

        header {
            padding: 0.8rem 1rem; background: rgba(30, 41, 59, 0.9);
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(5px);
        }

        #canvas-section {
            padding: 10px; display: flex; flex-direction: column; align-items: center;
        }

        .canvas-wrapper {
            position: relative; width: 100%; max-width: 420px; aspect-ratio: 1/1;
            background: white; border-radius: 1.2rem; overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.4);
        }

        canvas { width: 100%; height: 100%; cursor: crosshair; touch-action: none; }

        .toolbar {
            display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; 
            width: 100%; max-width: 420px; justify-content: center;
            background: rgba(30, 41, 59, 0.5); padding: 10px; border-radius: 1rem;
        }

        .tool-group { display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.05); padding: 5px 10px; border-radius: 0.5rem; }

        input[type="color"] { border: none; width: 35px; height: 35px; background: none; cursor: pointer; }
        input[type="range"] { width: 60px; accent-color: var(--accent); }

        .emoji-btn { font-size: 1.2rem; background: none; border: 1px solid #444; padding: 5px; border-radius: 5px; cursor: pointer; transition: 0.2s; }
        .emoji-btn:hover { background: rgba(255,255,255,0.1); transform: scale(1.1); }

        /* HISTORIA */
        #history-section {
            flex: 1; overflow-y: auto; padding: 1rem;
            background: rgba(15, 23, 42, 0.3);
        }

        .chat-bubble {
            background: var(--card-dark); padding: 12px; border-radius: 1.2rem;
            margin-bottom: 1rem; border-left: 5px solid var(--accent);
            animation: slideIn 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
        }
        .user-info { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .user-info img { width: 30px; height: 30px; border-radius: 50%; }
        .chat-bubble b { color: var(--accent); font-size: 0.85rem; }
        .chat-bubble img.story-img { width: 100%; border-radius: 0.8rem; background: white; display: block; margin-top: 5px; }

        /* BOTONES */
        button {
            padding: 8px 15px; border-radius: 0.8rem; border: none;
            font-weight: bold; cursor: pointer; transition: 0.3s;
            color: white;
        }
        .btn-main { background: var(--accent); flex: 1; }
        .btn-secondary { background: #475569; font-size: 0.8rem; }
        .btn-undo { background: #f59e0b; font-size: 1.2rem; padding: 5px 10px; }
        .btn-danger { background: #ef4444; font-size: 0.75rem; }

        footer {
            padding: 10px; text-align: center; background: rgba(15, 23, 42, 0.8);
            font-size: 0.7rem; letter-spacing: 2px; color: #94a3b8;
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        .hidden { display: none !important; }
        @keyframes slideIn { from { opacity: 0; transform: scale(0.9) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
    </style>
</head>
<body>

    <!-- Pantalla de Login -->
    <div id="login-screen">
        <div class="login-box">
            <h1 style="margin:0 0 0.5rem 0; font-size: 2rem; background: linear-gradient(to right, #a78bfa, #f472b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">ParacoHistory</h1>
            
            <div class="avatar-upload">
                <img id="preview-avatar" src="https://cdn-icons-png.flaticon.com/512/149/149071.png" alt="Avatar">
                <input type="file" id="photo-input" accept="image/*" style="display:none">
                <button type="button" class="btn-secondary" onclick="document.getElementById('photo-input').click()">Subir Foto</button>
            </div>

            <input type="text" id="username" placeholder="Tu nombre art√≠stico..." 
                   style="width:100%; padding:14px; border-radius:12px; border:1px solid #334155; background:#0f172a; color:white; margin-bottom:1.5rem; outline:none">
            <button class="btn-main" style="width:100%; padding:14px" onclick="join()">Entrar al Lienzo</button>
        </div>
    </div>

    <!-- Interfaz de Juego -->
    <div id="app" class="app-container hidden">
        <header>
            <button class="btn-secondary" onclick="goBack()">‚Üê Salir</button>
            <div id="status">üé® <span id="user-tag" style="color:var(--accent); font-weight:bold"></span></div>
            <button class="btn-danger" onclick="clearAll()">Reiniciar</button>
        </header>

        <section id="canvas-section">
            <div class="canvas-wrapper">
                <canvas id="mainCanvas"></canvas>
            </div>
            
            <div class="toolbar">
                <div class="tool-group">
                    <input type="color" id="colorPicker" value="#8b5cf6">
                    <input type="range" id="sizePicker" min="2" max="50" value="5">
                    <button class="btn-undo" onclick="undoAction()" title="Deshacer">‚Ü©</button>
                </div>
                <div class="tool-group">
                    <button class="emoji-btn" onclick="setTool('pen')">üñåÔ∏è</button>
                    <button class="emoji-btn" onclick="setTool('emoji', 'üî•')">üî•</button>
                    <button class="emoji-btn" onclick="setTool('emoji', '‚≠ê')">‚≠ê</button>
                    <button class="emoji-btn" onclick="setTool('emoji', '‚ù§Ô∏è')">‚ù§Ô∏è</button>
                    <button class="emoji-btn" onclick="setTool('emoji', 'üòÇ')">üòÇ</button>
                </div>
                <button class="btn-main" onclick="publishDrawing()">PUBLICAR MI PARTE</button>
            </div>
        </section>

        <section id="history-section">
            <div id="chat-flow"></div>
        </section>

        <footer>DEVELOPER - ROBERT PARACO</footer>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
           apiKey: "AIzaSyBMoyUF0bxIQtjZeZwK7nUal2gDUHWp_mc",
           authDomain: "history-4d35c.firebaseapp.com",
           projectId: "history-4d35c",
           databaseURL: "https://history-4d35c-default-rtdb.firebaseio.com",
           storageBucket: "history-4d35c.firebasestorage.app",
           messagingSenderId: "609419245306",
           appId: "1:609419245306:web:db65199fb17148dbb8bb43"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const drawingRef = db.ref('canvas_state');
        const historyRef = db.ref('story_history');

        let user = "";
        let userPhoto = "https://cdn-icons-png.flaticon.com/512/149/149071.png";
        let currentTool = 'pen';
        let currentEmoji = '';
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        const chatFlow = document.getElementById('chat-flow');
        const historySection = document.getElementById('history-section');
        let isDrawing = false;
        let lastPos = null;

        // Manejo de foto de perfil
        document.getElementById('photo-input').onchange = function(e) {
            const reader = new FileReader();
            reader.onload = function() {
                userPhoto = reader.result;
                document.getElementById('preview-avatar').src = userPhoto;
            };
            reader.readAsDataURL(e.target.files[0]);
        };

        function initCanvas() {
            const size = canvas.parentElement.offsetWidth;
            canvas.width = size;
            canvas.height = size;
            resetCanvasStyle();
        }

        function resetCanvasStyle() {
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        function join() {
            user = document.getElementById('username').value.trim();
            if(!user) return alert("Escribe tu nombre");
            document.getElementById('user-tag').innerText = user;
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            initCanvas();
            startListeners();
        }

        function goBack() {
            if(confirm("¬øVolver al inicio?")) {
                location.reload();
            }
        }

        function undoAction() {
            // Elimina el √∫ltimo trazo subido a Firebase
            drawingRef.limitToLast(1).once('child_added', (snap) => {
                snap.ref.remove();
            });
        }

        function setTool(tool, emoji = '') {
            currentTool = tool;
            currentEmoji = emoji;
        }

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return {
                x: (clientX - rect.left) / canvas.width,
                y: (clientY - rect.top) / canvas.height
            };
        }

        function handleStart(e) {
            isDrawing = true;
            const pos = getPos(e);
            if(currentTool === 'emoji') {
                placeEmoji(pos);
            } else {
                lastPos = pos;
            }
        }

        function handleMove(e) {
            if(!isDrawing || currentTool !== 'pen') return;
            const pos = getPos(e);
            const color = document.getElementById('colorPicker').value;
            const size = document.getElementById('sizePicker').value;

            drawingRef.push({
                type: 'line',
                x1: lastPos.x, y1: lastPos.y,
                x2: pos.x, y2: pos.y,
                color: color,
                size: size
            });
            lastPos = pos;
        }

        function placeEmoji(pos) {
            const size = document.getElementById('sizePicker').value;
            drawingRef.push({
                type: 'emoji',
                x: pos.x, y: pos.y,
                content: currentEmoji,
                size: size
            });
        }

        canvas.addEventListener('mousedown', handleStart);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); handleStart(e); });
        window.addEventListener('mouseup', () => isDrawing = false);
        window.addEventListener('touchend', () => isDrawing = false);
        canvas.addEventListener('mousemove', handleMove);
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); handleMove(e); });

        function startListeners() {
            drawingRef.on('child_added', (snap) => {
                const data = snap.val();
                if(data.type === 'line') {
                    ctx.beginPath();
                    ctx.strokeStyle = data.color;
                    ctx.lineWidth = data.size;
                    ctx.moveTo(data.x1 * canvas.width, data.y1 * canvas.height);
                    ctx.lineTo(data.x2 * canvas.width, data.y2 * canvas.height);
                    ctx.stroke();
                } else if(data.type === 'emoji') {
                    ctx.font = `${data.size * 2}px serif`;
                    ctx.fillText(data.content, data.x * canvas.width, data.y * canvas.height);
                }
            });

            // Escuchar borrados para el Undo o Clear
            drawingRef.on('child_removed', () => {
                // Redibujar todo el lienzo cuando algo se borra
                resetCanvasStyle();
                drawingRef.once('value', (snapshot) => {
                    snapshot.forEach((child) => {
                        const data = child.val();
                        if(data.type === 'line') {
                            ctx.beginPath();
                            ctx.strokeStyle = data.color;
                            ctx.lineWidth = data.size;
                            ctx.moveTo(data.x1 * canvas.width, data.y1 * canvas.height);
                            ctx.lineTo(data.x2 * canvas.width, data.y2 * canvas.height);
                            ctx.stroke();
                        } else if(data.type === 'emoji') {
                            ctx.font = `${data.size * 2}px serif`;
                            ctx.fillText(data.content, data.x * canvas.width, data.y * canvas.height);
                        }
                    });
                });
            });

            historyRef.on('child_added', (snap) => {
                const data = snap.val();
                addToHistory(data.user, data.photo, data.img);
            });
        }

        function publishDrawing() {
            const dataUrl = canvas.toDataURL('image/webp', 0.5);
            historyRef.push({
                user: user,
                photo: userPhoto,
                img: dataUrl
            });
        }

        function addToHistory(author, photo, imgData) {
            const div = document.createElement('div');
            div.className = 'chat-bubble';
            div.innerHTML = `
                <div class="user-info">
                    <img src="${photo}">
                    <b>${author} a√±adi√≥ un cap√≠tulo:</b>
                </div>
                <img src="${imgData}" class="story-img">
            `;
            chatFlow.appendChild(div);
            setTimeout(() => {
                historySection.scrollTo({ top: historySection.scrollHeight, behavior: 'smooth' });
            }, 100);
        }

        function clearAll() {
            if(confirm("¬øReiniciar todo?")) {
                drawingRef.remove();
                historyRef.remove();
                chatFlow.innerHTML = "";
            }
        }

        window.addEventListener('resize', initCanvas);
    </script>
</body>
</html>
